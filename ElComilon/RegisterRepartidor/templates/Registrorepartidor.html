{% extends "HeaderFooter/base-sidebar.html"%}

{% load static %}
{% block content%}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'css/stylesrepartidor.css'%}">
    <title>Document</title>
</head>

<body>
    <div class="container_login container">

        <div class="row ">
            <div class="card shadow-lg p3  mt-5 bg-white">
                <h1 class="h1-reg-repartidor mt-3 text-center">
                    Registrar Repartidor
                </h1>
                <div class="card-body div-body">
                    <form action="" class="mt-1 form row" id="post-form" method="POST">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-6">
                                {% include "HeaderFooter/formularioRegistro.html"%}
                            </div>
                            <div class="col-6 mt-3">
                                <div class="form-group">
                                    <div class="row ">
                                        <div class="col divinput">
                                            <div class="form-floating">
                                                {% if campos.0 %}
                                                <input type="text" id="txt-rut"
                                                class="form-control  input_rut" maxlength="10"
                                                oninput="checkRut(this)"  value="{{campos.0}}" name="RutRepartidor"
                                                placeholder="20.321.105-4" required>
                                                {% else %}
                                                <input type="text" id="txt-rut"
                                                class="form-control  input_rut" maxlength="10"
                                                oninput="checkRut(this)" name="RutRepartidor"
                                                placeholder="20.321.105-4" required>
                                                {% endif %}
                                                <label for="" class="label-input">Rut Repartidor</label>
                                                <small id="Msg" class="text-danger fs-6 mt-1"> </small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 col-sm-12 ">
                                            <div class="form-floating">
                                                {% if campos.1 %}
                                                <input type="text" class="form-control " minlength="2"
                                                    name="NombresRepartido" value="{{campos.1}}" placeholder="Nombres Repartidor" required>
                                                {% else %}
                                                <input type="text" class="form-control " minlength="2"
                                                    name="NombresRepartido" placeholder="Nombres Repartidor" required>
                                                {% endif %}
                                                <label for="">Nombres Repartidor</label>
                                            </div>

                                        </div>
                                        <div class="col-md-6 col-sm-12 divinput">
                                            <div class="form-floating">
                                                {% if campos.2 %}
                                                <input type="text" class="form-control " minlength="2"
                                                    name="ApellidosRepartidor" value="{{campos.2}}" placeholder="Apellidos Repartidor"
                                                    required>
                                                {% else %}
                                                <input type="text" class="form-control " minlength="2"
                                                    name="ApellidosRepartidor" placeholder="Apellidos Repartidor"
                                                    required>
                                                {% endif %}
                                                <label for="">Apellidos Repartidor</label>
                                            </div>

                                        </div>
                                    </div>
                                    <div class="row ">
                                        <div class="col-6 ">
                                            <div class="form-floating">
                                                {% if campos.3 %}
                                                <input type="date" class="form-control "
                                                name="Fechacontrato" value="{{campos.3}}" placeholder="Fecha contrato" id="datefield"
                                                style="color: gray;" required>
                                                {% else %}
                                                <input type="date" id="fechaContrato" class="form-control "
                                                name="Fechacontrato" placeholder="Fecha contrato" id="datefield"
                                                style="color: gray;" required>
                                                {% endif %}
                                                <label for="">Fecha contrato</label>
                                            </div>
                                        </div>
                                        <div class=" col-6 col-md-6 col-sm-12 divinput">
                                            <div class="form-floating">
                                                {% if campos.5 %}
                                                <input type="text" class="form-control " name="Patente"
                                                id="txt-patente" maxlength="6" value="{{campos.5}}" pattern="^[A-z]{4}[0-9]{2}$"
                                                placeholder="Patente vehiculo" required>
                                                {% else %}
                                                <input type="text" class="form-control " name="Patente"
                                                id="txt-patente" maxlength="6" pattern="^[A-z]{4}[0-9]{2}$"
                                                placeholder="Patente vehiculo" required>
                                                {% endif %}
                                                <label for="">Patente vehiculo</label>
                                            </div>
                                            <small id="patente" class="text-danger fs-6 mt-1"> </small>

                                        </div>
                                    </div>
                                    <div class="row ">
                                        <div class="col-md-6 col-sm-12 divinput ">
                                            <div class="form-floating">
                                                {% if campos.6 %}
                                                <input type="text" class="form-control " name="Modelo"
                                                    pattern="[a-zA-Z ]{3,8}*[ 0-9]" value="{{campos.6}}" placeholder="Modelo" required>
                                                {% else %}
                                                <input type="text" class="form-control " name="Modelo"
                                                    pattern="[a-zA-Z ]{3,8}*[ 0-9]" placeholder="Modelo" required>
                                                {% endif %}
                                                
                                                <label for="">Modelo Vehiculo</label>
                                                <div class="valid-feedback"> </div>
                                                <div class="invalid-feedback">Complete el campo</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6 col-sm-12 divinput">
                                            <div class="">                                               
                                                <div class="form-floating  align-self-start">
                                                    <select id="añoveh"  name="Ano"
                                                        class="combobox-tipovehiculo  form-select" required>
                                                        <option value="2010">2010</option>
                                                        <option value="2011">2011</option>
                                                        <option value="2012">2012</option>
                                                        <option value="2013">2013</option>
                                                        <option value="2014">2014</option>
                                                        <option value="2015">2015</option>
                                                        <option value="2016">2016</option>
                                                        <option value="2017">2017</option>
                                                        <option value="2018">2018</option>
                                                        <option value="2019">2019</option>
                                                        <option value="2020">2020</option>
                                                        <option value="2021">2021</option>
                                                        <option value="2022">2022</option>
                                                    </select>
                                                    <label for="">Año vehiculo</label>
                                                </div>
                                            </div>

                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-6  divinput">
                                            <div class="form-floating">
                                                {% if campos.8 %}
                                                <input type="text" class="form-control"
                                                    name="Color" pattern="[a-zA-Z]{3,8}" value="{{campos.8}}" placeholder="Color" required>
                                                {% else %}
                                                <input type="text" class="form-control"
                                                    name="Color" pattern="[a-zA-Z]{3,8}" placeholder="Color" required>
                                                {% endif %}
                                                <label for="">Color Vehiculo</label>
                                            </div>
                                        </div>
                                        <div class="col-6  divinput">
                                            {% if campos.0 %}
                                            {% else %}
                                            {% endif %}
                                            <div class="form-floating">
                                                <select name="tipovehiculo" id="tipovehiculo"
                                                    class="combobox-tipovehiculo  form-select">
                                                    {% for v in categoria %}
                                                    <option value="{{v.0}}">{{v.1}}</option>
                                                    {% endfor %}
                                                </select>
                                                <label>Tipo Vehiculo</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row ">
                                <button id="btn-repartidor" type="submit" class="Btn_repartidor btntest"> Registrar
                                    Repartidor
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

        </div>
        <!-- <script src="{% static 'app/jquery.rut.chileno.js' %}"></script> -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <script type="text/javascript">
            var today = new Date();
            var dd = today.getDate();
            var mm = today.getMonth() + 1; //January is 0!
            var yyyy = today.getFullYear();
            document.getElementById('fechaContrato').value = today
            if (dd < 10) {
                dd = '0' + dd;
            }

            if (mm < 10) {
                mm = '0' + mm;
            }

            today = yyyy + '-' + mm + '-' + dd;
            document.getElementById("datefield").setAttribute("max", today);
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            $('#post-form').on('submit', function (event) {
                event.preventDefault();
                let inputrut = document.getElementById('txt-rut')
                let rut = document.getElementById('txt-rut').value;
                let patente = document.getElementById('txt-patente').value;
                var formData = new FormData(document.getElementById('post-form'));

                formData.append('rut', rut);
                formData.append('patente', patente);
                if (rut && document.getElementById('post-form').checkValidity()) {
                    document.getElementById('post-form')
                    fetch('{% url "validarRut" %}', {
                        method: 'POST',
                        mode: 'same-origin',
                        cache: 'no-cache',
                        body: formData,
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken'),
                        },
                    }).then(response => response.json())
                        .then(data => {
                            
                            if (data.val_rut === false) {
                                document.getElementById("Msg").innerHTML ="Este rut ya existe";   

                            }
                            else if (data.val_patente === false) {
                            
                                document.getElementById("patente").innerHTML ="Patente ya utilizada";   
                            }
                            else {
                                fetch('{% url "regin" %}'), {
                                    method: 'POST',
                                    mode: 'same-origin',
                                    cache: 'no-cache',
                                    body: formData,
                                    headers: {
                                        'X-CSRFToken': getCookie('csrftoken'),
                                    },
                                }
                                $('#post-form').submit();
                             
                            }
                        });
                } else {
                    event.preventDefault();
                }
            });
        </script>

        <script type="text/javascript"> jQuery(document).ready(function ($) { $('.input_rut').rut(); });</script>
       
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
            crossorigin="anonymous"></script>
        <script src="https://code.jquery.com/jquery-3.3.1.js"></script>

</body>

</html>
{% endblock%}
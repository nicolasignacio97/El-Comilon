{% extends "HeaderFooter/base-sidebar.html"%}
{% load crispy_forms_tags %}
{% load static %}
{% block content%}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'css/stylesrepartidor.css'%}">
    <title>Document</title>
</head>

<body>
    <div class="container_login container">

        <div class="row ">
            {% if messages %}
            <ul class="messages">
                {% for message in messages %}
                <li {% if message.tags %} class=" alert alert-success {{ message.tags }}" {% endif %}
                    style="list-style: none;">{{ message }}</li>
                {% endfor %}
            </ul>
            {% endif %}
            <div class="card shadow-lg p3  mt-5 bg-white">
                <h1 class="h1-reg-repartidor mt-3 text-center">
                    Registrar Repartidor
                </h1>
                <div class="card-body div-body">
                    <form action="" class="mt-1 form row needs-validation" id="post-form" method="POST" novalidate>
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-6">
                                {{form|crispy}}
                            </div>
                            <div class="col-6">
                                <div class="form-group">
                                    <div class="row ">
                                        <div class="col divinput">
                                            <div class="form-floating">
                                                <input type="text" id="txt-rut"
                                                    class="form-control input-repartidor input_rut" maxlength="10"
                                                    oninput="checkRut(this)" name="RutRepartidor"
                                                    placeholder="20.321.105-4" required>
                                                <label for="" class="label-input">Rut Repartidor</label>
                                                <div class="valid-feedback"> </div>
                                                <div class="invalid-feedback">Complete el campo</div>
                                            </div>

                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 col-sm-12 ">
                                            <div class="form-floating">
                                                <input type="text" class="form-control input-repartidor" minlength="2"
                                                    name="NombresRepartido" placeholder="Nombres Repartidor" required>
                                                <label for="">Nombre Repartidor</label>
                                                <div class="valid-feedback"> </div>
                                                <div class="invalid-feedback">Complete el campo</div>
                                            </div>

                                        </div>
                                        <div class="col-md-6 col-sm-12 divinput">
                                            <div class="form-floating">
                                                <input type="text" class="form-control input-repartidor" minlength="2"
                                                    name="ApellidosRepartidor" placeholder="Apellidos Repartidor"
                                                    required>
                                                <label for="">Apellido Repartidor</label>
                                                <div class="valid-feedback"> </div>
                                                <div class="invalid-feedback">Complete el campo</div>
                                            </div>

                                        </div>
                                    </div>
                                    <div class="row ">
                                        <div class="col-md-6 col-sm-12 divinput">
                                            <div class="form-floating">
                                                <input type="date" class="form-control input-repartidor"
                                                    name="Fechacontrato" placeholder="Fecha contrato" id="datefield"
                                                    style="color: gray;" required>
                                                <label for="">Fecha contrato</label>
                                                <div class="valid-feedback"> </div>
                                                <div class="invalid-feedback">Complete el campo</div>
                                            </div>

                                        </div>
                                        <div class="col-md-6 col-sm-12">
                                            <div class="form-floating">
                                                <select name="rutempresa" id=""
                                                    class="combobox-tipovehiculo  form-select">
                                                    <option value="SELECCIONE">Rut restaurante</option>
                                                    {% for v in restaurante %}
                                                    <option value="{{v.0}}">{{v.0}}</option>
                                                    {% endfor %}
                                                </select>
                                                <label for="">Rut Restaurante</label>
                                                <div class="valid-feedback"> </div>
                                                <div class="invalid-feedback">Complete el campo</div>
                                            </div>

                                        </div>
                                    </div>
                                    <div class="row ">
                                        <div class="col-md-6 col-sm-12 divinput">
                                            <div class="form-floating">
                                                <input type="text" class="form-control input-repartidor" name="Patente"
                                                    id="txt-patente" maxlength="6" pattern="^[A-z]{4}[0-9]{2}$"
                                                    placeholder="Patente vehiculo" required>
                                                <label for="">Patente vehiculo</label>
                                                <div class="valid-feedback"> </div>
                                                <div class="invalid-feedback">Complete el campo</div>
                                            </div>

                                        </div>
                                        <div class="col-md-6 col-sm-12 divinput ">
                                            <div class="form-floating">
                                                <input type="text" class="form-control input-repartidor" name="Modelo"
                                                    pattern="[a-zA-Z ]{3,8}*[ 0-9]" placeholder="Modelo" required>
                                                <label for="">Modelo Vehiculo</label>
                                                <div class="valid-feedback"> </div>
                                                <div class="invalid-feedback">Complete el campo</div>
                                            </div>

                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6 col-sm-12 divinput">
                                            <div class="form-floating">
                                                <input type="text" class="form-control input-repartidor" name="Ano"
                                                    maxlength="4" pattern="[0-9]{4}$" placeholder="Año vehiculo"
                                                    required>
                                                <label for="">Año vehiculo</label>
                                                <div class="valid-feedback"> </div>
                                                <div class="invalid-feedback">Complete el campo</div>
                                            </div>

                                        </div>
                                        <div class="col-md-6 col-sm-12 divinput">
                                            <div class="form-floating">
                                                <input type="text" class="form-control input-repartidor m-0"
                                                    name="Color" pattern="[a-zA-Z]{3,8}" placeholder="Color" required>
                                                <label for="">Color Vehiculo</label>
                                                <div class="valid-feedback"> </div>
                                                <div class="invalid-feedback">Complete el campo</div>
                                            </div>

                                        </div>
                                    </div>
                                    <div class="row align-self-center">
                                    </div>
                                    <div class="row  mb-4">
                                        <div class="col  align-self-center">
                                            <select name="tipovehiculo" id="tipovehiculo"
                                                class="combobox-tipovehiculo  form-select">
                                                <option value="SELECCIONE">Tipo Vehiculo</option>
                                                {% for v in categoria %}
                                                <option value="{{v.0}}">{{v.1}}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row ">
                                <button id="btn-repartidor" type="submit" class="Btn_repartidor btntest"> Registrar
                                    Repartidor
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

        </div>
        <!-- <script src="{% static 'app/jquery.rut.chileno.js' %}"></script> -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <script type="text/javascript">
            var today = new Date();
            var dd = today.getDate();
            var mm = today.getMonth() + 1; //January is 0!
            var yyyy = today.getFullYear();

            if (dd < 10) {
                dd = '0' + dd;
            }

            if (mm < 10) {
                mm = '0' + mm;
            }

            today = yyyy + '-' + mm + '-' + dd;
            document.getElementById("datefield").setAttribute("max", today);
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            $('#post-form').on('submit', function (event) {
                event.preventDefault();
                let inputrut = document.getElementById('txt-rut')
                let rut = document.getElementById('txt-rut').value;
                let patente = document.getElementById('txt-patente').value;
                var formData = new FormData(document.getElementById('post-form'));

                formData.append('rut', rut);
                formData.append('patente', patente);
                if (rut && document.getElementById('post-form').checkValidity()) {
                    document.getElementById('post-form').classList.add('was-validated')
                    fetch('{% url "validarRut" %}', {
                        method: 'POST',
                        mode: 'same-origin',
                        cache: 'no-cache',
                        body: formData,
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken'),
                        },
                    }).then(response => response.json())
                        .then(data => {
                            console.log(data)
                            if (data.val_rut === false) {
                                alert('Usuario rut no permitido')
                                console.log("Usuario rut no permitido")

                            }
                            else if (data.val_patente === false) {
                                alert('Patente no valida')
                                console.log('Patente no valida')
                            }
                            else {
                                fetch('{% url "regin" %}'), {
                                    method: 'POST',
                                    mode: 'same-origin',
                                    cache: 'no-cache',
                                    body: formData,
                                    headers: {
                                        'X-CSRFToken': getCookie('csrftoken'),
                                    },
                                }
                                $('#post-form').submit();
                                console.log("Repartidor Correcto en la bd")
                            }
                        });
                } else {

                    console.log("Llene todos los campos")
                    event.preventDefault();
                }
            });
        </script>

        <script type="text/javascript"> jQuery(document).ready(function ($) { $('.input_rut').rut(); });</script>
       
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
            crossorigin="anonymous"></script>
        <script src="https://code.jquery.com/jquery-3.3.1.js"></script>

</body>

</html>
{% endblock%}